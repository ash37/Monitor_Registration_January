name: Monitor Registration

on:
  schedule:
    - cron: "*/30 * * * *"   # every 30 minutes
  workflow_dispatch: {}

permissions:
  issues: write
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch page and detect open/closed
        id: check
        shell: bash
        run: |
          set -u -o pipefail

          URL="https://registration.rundisney.com/?event=a3069dc761c8d71ead58&utm_source=teamrundis&utm_medium=rundisalerts"
          CLOSED_TEXT="The registration for this event is closed"

          body="$(mktemp)"

          # Run curl without failing the step
          set +e
          final_url_and_code="$(
            curl -sS -L \
              -A "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome Safari" \
              -H "Accept-Language: en-US,en;q=0.9" \
              -o "$body" \
              -w $'\n%{url_effective}\n%{http_code}\n' \
              "$URL"
          )"
          curl_rc=$?
          set -e

          final_url="$(echo "$final_url_and_code" | sed -n '2p')"
          http_code="$(echo "$final_url_and_code" | sed -n '3p')"

          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "final_url=$final_url" >> "$GITHUB_OUTPUT"
          echo "http_code=$http_code" >> "$GITHUB_OUTPUT"

          # Any curl error or non-200 => not open
          if [ "$curl_rc" -ne 0 ] || [ "$http_code" != "200" ]; then
            echo "open=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Queue/holding pages => not open
          if echo "$final_url" | grep -Eqi "queue\.registration\.rundisney\.com|akamai|queue-it|waitingroom"; then
            echo "open=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          html="$(cat "$body")"

          # Trigger when closed marker disappears
          if echo "$html" | grep -qi "$CLOSED_TEXT"; then
            echo "open=false" >> "$GITHUB_OUTPUT"
          else
            echo "open=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create issue (only once)
        if: steps.check.outputs.open == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = "ðŸš¨ Registration appears OPEN";
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const existing = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue is:open in:title "${title}"`
            });

            if (existing.data.total_count > 0) {
              core.info("Issue already exists; skipping.");
              return;
            }

            const url = `${{ steps.check.outputs.url }}`;
            const finalUrl = `${{ steps.check.outputs.final_url }}`;
            const httpCode = `${{ steps.check.outputs.http_code }}`;

            await github.rest.issues.create({
              owner, repo,
              title,
              body: [
                "Closed marker text is no longer present AND request did not land on a queue/holding page.",
                "",
                `URL: ${url}`,
                `Final URL: ${finalUrl}`,
                `HTTP: ${httpCode}`,
                "",
                `Ping: @${owner}`
              ].join("\n")
            });
