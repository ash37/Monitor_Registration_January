name: Monitor Registration

on:
  schedule:
    - cron: "*/30 * * * *"   # every 30 minutes
  workflow_dispatch: {}

permissions:
  issues: write
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch page and check CLOSED marker
        id: check
        run: |
          set -e
          URL="https://registration.rundisney.com/?event=a3069dc761c8d71ead58&utm_source=teamrundis&utm_medium=rundisalerts"
          CLOSED_TEXT="The registration for this event is closed"

          html="$(curl -fsSL "$URL")"

          if echo "$html" | grep -qi "$CLOSED_TEXT"; then
            echo "open=false" >> "$GITHUB_OUTPUT"
          else
            echo "open=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create issue (only once)
        if: steps.check.outputs.open == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = "ðŸš¨ Registration appears OPEN";
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // Avoid duplicates: if there's already an open issue with this title, do nothing.
            const existing = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue is:open in:title "${title}"`
            });

            if (existing.data.total_count > 0) {
              core.info("Issue already exists; skipping.");
              return;
            }

            await github.rest.issues.create({
              owner, repo,
              title,
              body: [
                "Closed marker text is no longer present on the registration page.",
                "",
                `URL: ${process.env.URL || "see workflow step"}`,
                `Ping: @${owner}`
              ].join("\n")
            });
